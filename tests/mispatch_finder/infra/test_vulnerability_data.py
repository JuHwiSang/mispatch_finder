import pytest
import os

from mispatch_finder.core.domain.models import Vulnerability
from mispatch_finder.infra.vulnerability_data import (
    VulnerabilityDataAdapter,
    _choose_commit,
)


def test_choose_commit_prefers_longer_hashes():
    commits = ["abc123", "abc123456789", "xyz"]
    assert _choose_commit(commits) == "abc123456789"


def test_choose_commit_validates_format():
    # _choose_commit validates hex format (7-40 chars)
    commits = ["invalid!", "abc1234", "not-a-hash"]  # abc1234 is valid 7-char hex
    assert _choose_commit(commits) == "abc1234"


def test_choose_commit_returns_none_for_invalid():
    commits = ["invalid", "bad-hash!", "123xyz!"]
    assert _choose_commit(commits) is None


def test_choose_commit_accepts_full_sha():
    full_sha = "a" * 40
    commits = ["abc123", full_sha]
    assert _choose_commit(commits) == full_sha


@pytest.mark.skipif(not os.environ.get("MISPATCH_FINDER_GITHUB__TOKEN"), reason="MISPATCH_FINDER_GITHUB__TOKEN not set")
def test_vulnerability_data_list_vulnerabilities_ids_only():
    """Integration test: list vulnerabilities with detailed=False."""
    adapter = VulnerabilityDataAdapter(github_token=os.environ["MISPATCH_FINDER_GITHUB__TOKEN"])

    ids = adapter.list_vulnerabilities(limit=5, ecosystem="npm", detailed=False)

    assert isinstance(ids, list)
    assert len(ids) <= 5
    for ghsa in ids:
        assert isinstance(ghsa, str)
        assert ghsa.startswith("GHSA-")
        # Validate GHSA format: GHSA-xxxx-xxxx-xxxx
        parts = ghsa.split("-")
        assert len(parts) == 4
        assert parts[0] == "GHSA"


@pytest.mark.skipif(not os.environ.get("MISPATCH_FINDER_GITHUB__TOKEN"), reason="MISPATCH_FINDER_GITHUB__TOKEN not set")
def test_vulnerability_data_list_vulnerabilities_detailed():
    """Integration test: list vulnerabilities with detailed=True."""
    adapter = VulnerabilityDataAdapter(github_token=os.environ["MISPATCH_FINDER_GITHUB__TOKEN"])

    vulns = adapter.list_vulnerabilities(limit=3, ecosystem="npm", detailed=True)

    assert isinstance(vulns, list)
    assert len(vulns) <= 3
    for vuln in vulns:
        assert isinstance(vuln, Vulnerability)
        assert vuln.ghsa_id.startswith("GHSA-")
        assert vuln.repository.owner
        assert vuln.repository.name
        assert vuln.commit_hash
        # Check optional fields are present (may be None)
        assert hasattr(vuln, "cve_id")
        assert hasattr(vuln, "severity")
        assert hasattr(vuln, "summary")




@pytest.mark.skipif(not os.environ.get("MISPATCH_FINDER_GITHUB__TOKEN"), reason="MISPATCH_FINDER_GITHUB__TOKEN not set")
def test_vulnerability_repository_fetch_metadata_real():
    """Integration test: requires MISPATCH_FINDER_GITHUB__TOKEN and real GHSA."""
    token = os.environ.get("MISPATCH_FINDER_GITHUB__TOKEN", "")
    adapter = VulnerabilityDataAdapter(github_token=token)

    # Use a known-good GHSA ID
    vuln = adapter.fetch_metadata("GHSA-93vw-8fm5-p2jf")

    assert vuln.ghsa_id == "GHSA-93vw-8fm5-p2jf"
    assert vuln.repository.owner
    assert vuln.repository.name
    assert vuln.commit_hash

