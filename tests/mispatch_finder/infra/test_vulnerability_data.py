import pytest
import os

from mispatch_finder.infra.vulnerability_data import (
    VulnerabilityDataAdapter,
    _choose_commit,
)


def test_choose_commit_prefers_longer_hashes():
    commits = ["abc123", "abc123456789", "xyz"]
    assert _choose_commit(commits) == "abc123456789"


def test_choose_commit_validates_format():
    # _choose_commit validates hex format (7-40 chars)
    commits = ["invalid!", "abc1234", "not-a-hash"]  # abc1234 is valid 7-char hex
    assert _choose_commit(commits) == "abc1234"


def test_choose_commit_returns_none_for_invalid():
    commits = ["invalid", "bad-hash!", "123xyz!"]
    assert _choose_commit(commits) is None


def test_choose_commit_accepts_full_sha():
    full_sha = "a" * 40
    commits = ["abc123", full_sha]
    assert _choose_commit(commits) == full_sha


@pytest.mark.skipif(not os.environ.get("GITHUB_TOKEN"), reason="GITHUB_TOKEN not set")
def test_vulnerability_repository_list_ids():
    """Integration test: requires GITHUB_TOKEN."""
    repo = VulnerabilityDataAdapter(github_token=os.environ["GITHUB_TOKEN"])

    ids = repo.list_ids(limit=5, ecosystem="npm")

    assert isinstance(ids, list)
    assert len(ids) <= 5
    for ghsa in ids:
        assert ghsa.startswith("GHSA-")
        # Validate GHSA format: GHSA-xxxx-xxxx-xxxx
        parts = ghsa.split("-")
        assert len(parts) == 4
        assert parts[0] == "GHSA"




@pytest.mark.skipif(not os.environ.get("GITHUB_TOKEN"), reason="GITHUB_TOKEN not set")
def test_vulnerability_repository_fetch_metadata_real():
    """Integration test: requires GITHUB_TOKEN and real GHSA."""
    token = os.environ.get("GITHUB_TOKEN", "")
    repo = VulnerabilityDataAdapter(github_token=token)

    # Use a known-good GHSA ID
    vuln = repo.fetch_metadata("GHSA-93vw-8fm5-p2jf")

    assert vuln.ghsa_id == "GHSA-93vw-8fm5-p2jf"
    assert vuln.repository.url
    assert vuln.commit_hash
    assert vuln.repository.owner
    assert vuln.repository.name


def test_vulnerability_repository_sets_env_token():
    """Test that the adapter sets GITHUB_TOKEN in environment."""
    token = "ghp-test-token"
    original = os.environ.get("GITHUB_TOKEN")

    try:
        if "GITHUB_TOKEN" in os.environ:
            del os.environ["GITHUB_TOKEN"]

        repo = VulnerabilityDataAdapter(github_token=token)
        repo._ensure_token()
        
        assert os.environ.get("GITHUB_TOKEN") == token
    finally:
        if original:
            os.environ["GITHUB_TOKEN"] = original
        elif "GITHUB_TOKEN" in os.environ:
            del os.environ["GITHUB_TOKEN"]

